name: Test

on:
  push:
    branches: [ "main" ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/test.yml'

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      - name: Run unit tests
        run: go test ./... -v -short

  integration-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # SQLite - host - normal
          - db: sqlite
            path_style: host
            repl_mode: none
            blob_store: sql
            name: sqlite-host-normal-sql

          - db: sqlite
            path_style: host
            repl_mode: none
            blob_store: sql
            encrypt: "true"
            name: sqlite-host-normal-sql-encrypted

          - db: sqlite
            path_style: host
            repl_mode: none
            blob_store: filesystem
            name: sqlite-host-normal-fs

          - db: sqlite
            path_style: host
            repl_mode: none
            blob_store: filesystem
            encrypt: "true"
            name: sqlite-host-normal-fs-encrypted

          # SQLite - path - normal
          - db: sqlite
            path_style: path
            repl_mode: none
            blob_store: sql
            name: sqlite-path-normal-sql

          - db: sqlite
            path_style: path
            repl_mode: none
            blob_store: sql
            encrypt: "true"
            name: sqlite-path-normal-sql-encrypted

          - db: sqlite
            path_style: path
            repl_mode: none
            blob_store: filesystem
            name: sqlite-path-normal-fs

          - db: sqlite
            path_style: path
            repl_mode: none
            blob_store: filesystem
            encrypt: "true"
            name: sqlite-path-normal-fs-encrypted

          # SQLite - host - replicated
          - db: sqlite
            path_style: host
            repl_mode: replicated
            blob_store: sql
            name: sqlite-host-replicated-sql

          - db: sqlite
            path_style: host
            repl_mode: replicated
            blob_store: sql
            encrypt: "true"
            name: sqlite-host-replicated-sql-encrypted

          - db: sqlite
            path_style: host
            repl_mode: replicated
            blob_store: filesystem
            name: sqlite-host-replicated-fs

          - db: sqlite
            path_style: host
            repl_mode: replicated
            blob_store: filesystem
            encrypt: "true"
            name: sqlite-host-replicated-fs-encrypted

          # SQLite - path - replicated
          - db: sqlite
            path_style: path
            repl_mode: replicated
            blob_store: sql
            name: sqlite-path-replicated-sql

          - db: sqlite
            path_style: path
            repl_mode: replicated
            blob_store: sql
            encrypt: "true"
            name: sqlite-path-replicated-sql-encrypted

          - db: sqlite
            path_style: path
            repl_mode: replicated
            blob_store: filesystem
            name: sqlite-path-replicated-fs

          - db: sqlite
            path_style: path
            repl_mode: replicated
            blob_store: filesystem
            encrypt: "true"
            name: sqlite-path-replicated-fs-encrypted

          # Postgres - host - normal
          - db: postgres
            path_style: host
            repl_mode: none
            blob_store: sql
            name: postgres-host-normal-sql

          - db: postgres
            path_style: host
            repl_mode: none
            blob_store: sql
            encrypt: "true"
            name: postgres-host-normal-sql-encrypted

          - db: postgres
            path_style: host
            repl_mode: none
            blob_store: filesystem
            name: postgres-host-normal-fs

          - db: postgres
            path_style: host
            repl_mode: none
            blob_store: filesystem
            encrypt: "true"
            name: postgres-host-normal-fs-encrypted

          # Postgres - path - normal
          - db: postgres
            path_style: path
            repl_mode: none
            blob_store: sql
            name: postgres-path-normal-sql

          - db: postgres
            path_style: path
            repl_mode: none
            blob_store: sql
            encrypt: "true"
            name: postgres-path-normal-sql-encrypted

          - db: postgres
            path_style: path
            repl_mode: none
            blob_store: filesystem
            name: postgres-path-normal-fs

          - db: postgres
            path_style: path
            repl_mode: none
            blob_store: filesystem
            encrypt: "true"
            name: postgres-path-normal-fs-encrypted

          # Postgres - host - replicated
          - db: postgres
            path_style: host
            repl_mode: replicated
            blob_store: sql
            name: postgres-host-replicated-sql

          - db: postgres
            path_style: host
            repl_mode: replicated
            blob_store: sql
            encrypt: "true"
            name: postgres-host-replicated-sql-encrypted

          - db: postgres
            path_style: host
            repl_mode: replicated
            blob_store: filesystem
            name: postgres-host-replicated-fs

          - db: postgres
            path_style: host
            repl_mode: replicated
            blob_store: filesystem
            encrypt: "true"
            name: postgres-host-replicated-fs-encrypted

          # Postgres - path - replicated
          - db: postgres
            path_style: path
            repl_mode: replicated
            blob_store: sql
            name: postgres-path-replicated-sql

          - db: postgres
            path_style: path
            repl_mode: replicated
            blob_store: sql
            encrypt: "true"
            name: postgres-path-replicated-sql-encrypted

          - db: postgres
            path_style: path
            repl_mode: replicated
            blob_store: filesystem
            name: postgres-path-replicated-fs

          - db: postgres
            path_style: path
            repl_mode: replicated
            blob_store: filesystem
            encrypt: "true"
            name: postgres-path-replicated-fs-encrypted

    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      - name: Run integration tests
        env:
          TEST_NAME: ${{ matrix.name }}
        run: |
          args="-db ${{ matrix.db }} -path-style ${{ matrix.path_style }} -repl-mode ${{ matrix.repl_mode }} -blob-store ${{ matrix.blob_store }}"
          if [ "${{ matrix.encrypt }}" = "true" ]; then args="$args -encrypt-blob-store"; fi
          echo "Running: $TEST_NAME"
          go test ./... -v -timeout 2h -integration $args
